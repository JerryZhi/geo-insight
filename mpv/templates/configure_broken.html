<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>配置监测参数 - GEO Insight</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <style>
        .navbar-brand {
            font-weight: bold;
            color: #667eea !important;
        }
        .card {
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 25px;
        }
        .btn-outline-primary {
            border-color: #667eea;
            color: #667eea;
            border-radius: 25px;
        }
        .form-control, .form-select {
            border-radius: 10px;
        }
        .preview-box {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .step-indicator {
            position: relative;
            padding-left: 30px;
        }
        .step-indicator::before {
            content: attr(data-step);
            position: absolute;
            left: 0;
            top: 0;
            width: 25px;
            height: 25px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- 导航栏 -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('dashboard') }}">
                <i class="bi bi-graph-up"></i> GEO Insight
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('dashboard') }}">
                            <i class="bi bi-house"></i> 仪表板
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="{{ url_for('new_task') }}">
                            <i class="bi bi-plus-circle"></i> 新建任务
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('history') }}">
                            <i class="bi bi-clock-history"></i> 历史记录
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="{{ url_for('profile') }}">
                            <i class="bi bi-gear"></i> 配置管理
                        </a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown">
                            <i class="bi bi-person-circle"></i> {{ g.current_user.username }}
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="{{ url_for('profile') }}">个人设置</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="{{ url_for('logout') }}">退出登录</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-info alert-dismissible fade show" role="alert">
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <div class="row">
            <div class="col-lg-10 mx-auto">
                <!-- 文件预览 -->
                <div class="card mb-4">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="bi bi-file-text"></i> Prompts预览
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">已上传文件，共 {{ total_prompts }} 个prompts，以下是前10个预览：</p>
                        <div class="preview-box">
                            {% for prompt in prompts %}
                                <div class="mb-2 p-2 bg-white rounded border-start border-primary border-3">
                                    <small class="text-muted">{{ loop.index }}.</small>
                                    {{ prompt }}
                                </div>
                            {% endfor %}
                            {% if total_prompts > 10 %}
                                <div class="text-center text-muted mt-3">
                                    <i class="bi bi-three-dots"></i> 还有 {{ total_prompts - 10 }} 个prompts
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- 配置表单 -->
                <form action="{{ url_for('run_analysis') }}" method="post">
                    <input type="hidden" name="file_path" value="{{ file_path }}">
                    
                    <div class="row">
                        <!-- 左侧配置 -->
                        <div class="col-lg-8">
                            <!-- 任务配置 -->
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0 step-indicator" data-step="1">
                                        任务基本信息
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="task_name" class="form-label">任务名称</label>
                                        <input type="text" class="form-control" id="task_name" name="task_name" 
                                               placeholder="给这个任务起个名字" required>
                                    </div>
                                </div>
                            </div>

                            <!-- 品牌配置 -->
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0 step-indicator" data-step="2">
                                        品牌监测配置
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="brand_config_type" 
                                                   id="use_saved_brands" value="saved">
                                            <label class="form-check-label" for="use_saved_brands">
                                                使用已保存的品牌配置
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="brand_config_type" 
                                                   id="use_new_brands" value="new" checked>
                                            <label class="form-check-label" for="use_new_brands">
                                                创建新的品牌配置
                                            </label>
                                        </div>
                                    </div>

                                    <!-- 已保存配置选择 -->
                                    <div id="saved_brands_section" class="d-none">
                                        <label for="brand_config_id" class="form-label">选择品牌配置</label>
                                        <select class="form-select" id="brand_config_id" name="brand_config_id">
                                            {% for config in brand_configs %}
                                                <option value="{{ config.id }}">
                                                    品牌: {{ config.brand_names|join(', ') }}
                                                    {% if config.website_domains %}
                                                        | 域名: {{ config.website_domains|join(', ') }}
                                                    {% endif %}
                                                </option>
                                            {% endfor %}
                                        </select>
                                    </div>

                                    <!-- 新建配置 -->
                                    <div id="new_brands_section">
                                        <div class="mb-3">
                                            <label for="brands" class="form-label">监测品牌名称 *</label>
                                            <input type="text" class="form-control" id="brands" name="brands" 
                                                   placeholder="例如：苹果,微软,谷歌 (用逗号分隔)" required>
                                            <div class="form-text">输入要监测的品牌名称，用逗号分隔</div>
                                        </div>
                                        <div class="mb-3">
                                            <label for="domains" class="form-label">网站域名 (可选)</label>
                                            <input type="text" class="form-control" id="domains" name="domains" 
                                                   placeholder="例如：apple.com,microsoft.com,google.com">
                                            <div class="form-text">监测网站域名的提及，用逗号分隔</div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- API配置 -->
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0 step-indicator" data-step="3">
                                        大模型API配置
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="api_config_type" 
                                                   id="use_saved_api" value="saved" 
                                                   {% if api_configs %}checked{% endif %}>
                                            <label class="form-check-label" for="use_saved_api">
                                                使用已保存的API配置
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="api_config_type" 
                                                   id="use_new_api" value="new" 
                                                   {% if not api_configs %}checked{% endif %}>
                                            <label class="form-check-label" for="use_new_api">
                                                输入新的API配置
                                            </label>
                                        </div>
                                    </div>

                                    <!-- 已保存API配置选择 -->
                                    {% if api_configs %}
                                    <div id="saved_api_section" {% if not api_configs %}class="d-none"{% endif %}>
                                        <label for="api_config_id" class="form-label">选择API配置</label>
                                        <select class="form-select" id="api_config_id" name="api_config_id">
                                            {% for config in api_configs %}
                                                <option value="{{ config.id }}" 
                                                        {% if config.is_default %}selected{% endif %}>
                                                    {{ config.name }} - {{ config.endpoint }}
                                                    {% if config.is_default %} (默认){% endif %}
                                                </option>
                                            {% endfor %}
                                        </select>
                                        <div class="mt-2">
                                            <button type="button" class="btn btn-sm btn-outline-primary" id="test_saved_api">
                                                <i class="bi bi-check-circle"></i> 测试连接
                                            </button>
                                        </div>
                                    </div>
                                    {% endif %}

                                    <!-- 新建API配置 -->
                                    <div id="new_api_section" {% if api_configs %}class="d-none"{% endif %}>
                                        <div class="mb-3">
                                            <label for="api_endpoint" class="form-label">API端点 *</label>
                                            <input type="url" class="form-control" id="api_endpoint" name="api_endpoint" 
                                                   placeholder="https://api.openai.com/v1/chat/completions">
                                        </div>
                                        <div class="mb-3">
                                            <label for="api_key" class="form-label">API密钥 *</label>
                                            <input type="password" class="form-control" id="api_key" name="api_key" 
                                                   placeholder="sk-...">
                                        </div>
                                        <div class="mb-3">
                                            <label for="model" class="form-label">模型名称</label>
                                            <input type="text" class="form-control" id="model" name="model" 
                                                   placeholder="gpt-3.5-turbo">
                                        </div>
                                        <div class="mb-3">
                                            <button type="button" class="btn btn-outline-primary" id="test_api">
                                                <i class="bi bi-check-circle"></i> 测试API连接
                                            </button>
                                            <div id="api_test_result" class="mt-2"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 右侧高级设置 -->
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0 step-indicator" data-step="4">
                                        高级设置
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="concurrency" class="form-label">并发数量</label>
                                        <select class="form-select" id="concurrency" name="concurrency">
                                            <option value="1">1 (较慢但稳定)</option>
                                            <option value="2">2</option>
                                            <option value="3" selected>3 (推荐)</option>
                                            <option value="5">5 (较快)</option>
                                        </select>
                                        <div class="form-text">同时发送的请求数量</div>
                                    </div>
                                    <div class="mb-3">
                                        <label for="request_delay" class="form-label">请求延迟 (秒)</label>
                                        <select class="form-select" id="request_delay" name="request_delay">
                                            <option value="0.2">0.2</option>
                                            <option value="0.5" selected>0.5 (推荐)</option>
                                            <option value="1">1.0</option>
                                            <option value="2">2.0</option>
                                        </select>
                                        <div class="form-text">请求之间的间隔</div>
                                    </div>

                                    <div class="alert alert-info">
                                        <small>
                                            <i class="bi bi-info-circle"></i>
                                            <strong>提示：</strong> MVP版本最多处理20个prompts。
                                            降低并发数和增加延迟可以避免API限制。
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 提交按钮 -->
                    <div class="row mt-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body text-center">
                                    <h5>准备开始监测</h5>
                                    <p class="text-muted mb-4">
                                        将向大模型发送 {{ total_prompts }} 个prompts进行品牌可见性分析
                                    </p>
                                    <button type="submit" class="btn btn-primary btn-lg px-5">
                                        <i class="bi bi-play-circle"></i> 开始分析
                                    </button>
                                    <a href="{{ url_for('new_task') }}" class="btn btn-outline-secondary btn-lg px-4 ms-3">
                                        <i class="bi bi-arrow-left"></i> 返回
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

            <div class="row">
                <!-- Prompts预览 -->
                <div class="col-lg-4 mb-4">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0">
                                <i class="fas fa-eye me-2"></i>Prompts预览
                            </h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted">共 {{ total_prompts }} 个prompts</p>
                            <div class="preview-box">
                                {% for prompt in prompts %}
                                    <div class="mb-2 p-2 bg-white border rounded">
                                        <small class="text-muted">{{ loop.index }}.</small>
                                        {{ prompt[:100] }}{% if prompt|length > 100 %}...{% endif %}
                                    </div>
                                {% endfor %}
                                {% if total_prompts > 10 %}
                                    <div class="text-center text-muted">
                                        <small>还有 {{ total_prompts - 10 }} 个prompts...</small>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 配置表单 -->
                <div class="col-lg-8">
                    <form method="POST" action="/run_analysis">
                        <input type="hidden" name="file_path" value="{{ file_path }}">
                        
                        <!-- 品牌监测配置 -->
                        <div class="card mb-4">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-bullseye me-2"></i>品牌监测配置
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="brands" class="form-label">品牌名称 *</label>
                                            <input type="text" class="form-control" id="brands" name="brands" 
                                                   placeholder="例如: 苹果,华为,小米" required>
                                            <div class="form-text">多个品牌用逗号分隔</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="domains" class="form-label">网站域名</label>
                                            <input type="text" class="form-control" id="domains" name="domains" 
                                                   placeholder="例如: apple.com,huawei.com">
                                            <div class="form-text">多个域名用逗号分隔（可选）</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- LLM API配置 -->
                        <div class="card mb-4">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">
                                    <i class="fas fa-robot me-2"></i>LLM API配置
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <label for="api_endpoint" class="form-label">API端点 *</label>
                                            <select class="form-select mb-2" id="api_preset" onchange="setPreset()">
                                                <option value="">选择预设或自定义</option>
                                                <option value="openai">OpenAI GPT</option>
                                                <option value="claude">Anthropic Claude</option>
                                                <option value="xeduapi">XeduAPI (教育版)</option>
                                                <option value="custom">自定义API</option>
                                            </select>
                                            <input type="url" class="form-control" id="api_endpoint" name="api_endpoint" 
                                                   placeholder="https://api.openai.com/v1/chat/completions" required>
                                            <div class="form-text">
                                                <small>常见API端点：<br>
                                                • OpenAI: https://api.openai.com/v1/chat/completions<br>
                                                • Claude: https://api.anthropic.com/v1/messages<br>
                                                • 确保URL完整且正确
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="api_key" class="form-label">API密钥 *</label>
                                            <input type="password" class="form-control" id="api_key" name="api_key" 
                                                   placeholder="sk-..." required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="model" class="form-label">模型名称</label>
                                            <input type="text" class="form-control" id="model" name="model" 
                                                   placeholder="gpt-3.5-turbo">
                                            <div class="form-text">不填写将使用默认模型</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="concurrency" class="form-label">并发数设置</label>
                                            <select class="form-select" id="concurrency" name="concurrency">
                                                <option value="1">1 (顺序执行)</option>
                                                <option value="3" selected>3 (推荐)</option>
                                                <option value="5">5 (较快)</option>
                                                <option value="10">10 (快速)</option>
                                                <option value="20">20 (最快，可能被限流)</option>
                                            </select>
                                            <div class="form-text">
                                                <small>
                                                    <i class="fas fa-info-circle me-1"></i>
                                                    并发数越高速度越快，但可能触发API限流。建议从低开始测试。
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="request_delay" class="form-label">请求间隔 (秒)</label>
                                            <select class="form-select" id="request_delay" name="request_delay">
                                                <option value="0">0 (无延迟)</option>
                                                <option value="0.5" selected>0.5 (推荐)</option>
                                                <option value="1">1 (保守)</option>
                                                <option value="2">2 (很保守)</option>
                                            </select>
                                            <div class="form-text">
                                                <small>
                                                    <i class="fas fa-clock me-1"></i>
                                                    每个请求之间的延迟时间，避免触发限流
                                                </small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-12">
                                        <button type="button" class="btn btn-outline-info" onclick="testAPI()">
                                            <i class="fas fa-flask me-2"></i>测试API连接
                                        </button>
                                        <div id="api-test-result" class="mt-2"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 高级设置 -->
                        <div class="card mb-4">
                            <div class="card-header bg-warning">
                                <h5 class="mb-0">
                                    <i class="fas fa-cog me-2"></i>注意事项
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle me-2"></i>MVP版本限制：</h6>
                                    <ul class="mb-0">
                                        <li>最多处理前20个prompts</li>
                                        <li>支持OpenAI、Claude和XeduAPI格式</li>
                                        <li>查询结果会保存到本地文件</li>
                                        <li>请确保API密钥有足够的额度</li>
                                    </ul>
                                </div>
                                <div class="alert alert-warning">
                                    <h6><i class="fas fa-exclamation-triangle me-2"></i>并发设置建议：</h6>
                                    <ul class="mb-0">
                                        <li><strong>新API测试</strong>：建议使用并发数1，延迟1秒</li>
                                        <li><strong>稳定API</strong>：可以使用并发数3-5，延迟0.5秒</li>
                                        <li><strong>高性能API</strong>：可尝试并发数10+，但注意限流</li>
                                        <li>如遇到限流错误，请降低并发数或增加延迟</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg me-3">
                                <i class="fas fa-play me-2"></i>开始批量分析
                            </button>
                            <a href="/" class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-arrow-left me-2"></i>返回首页
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </section>

    <footer class="bg-dark text-white py-4">
        <div class="container text-center">
            <p class="mb-0">&copy; 2025 GEO Insight MVP. 简化版品牌监测工具</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 品牌配置类型切换
        document.querySelectorAll('input[name="brand_config_type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const savedSection = document.getElementById('saved_brands_section');
                const newSection = document.getElementById('new_brands_section');
                
                if (this.value === 'saved') {
                    savedSection.classList.remove('d-none');
                    newSection.classList.add('d-none');
                    // 清除新建配置的必填要求
                    document.getElementById('brands').removeAttribute('required');
                } else {
                    savedSection.classList.add('d-none');
                    newSection.classList.remove('d-none');
                    // 添加新建配置的必填要求
                    document.getElementById('brands').setAttribute('required', 'required');
                }
            });
        });

        // API配置类型切换
        document.querySelectorAll('input[name="api_config_type"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const savedSection = document.getElementById('saved_api_section');
                const newSection = document.getElementById('new_api_section');
                
                if (this.value === 'saved') {
                    savedSection.classList.remove('d-none');
                    newSection.classList.add('d-none');
                    // 清除新建配置的必填要求
                    document.getElementById('api_endpoint').removeAttribute('required');
                    document.getElementById('api_key').removeAttribute('required');
                } else {
                    savedSection.classList.add('d-none');
                    newSection.classList.remove('d-none');
                    // 添加新建配置的必填要求
                    document.getElementById('api_endpoint').setAttribute('required', 'required');
                    document.getElementById('api_key').setAttribute('required', 'required');
                }
            });
        });

        // 测试新API连接
        document.getElementById('test_api').addEventListener('click', function() {
            const btn = this;
            const result = document.getElementById('api_test_result');
            
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass"></i> 测试中...';
            
            const formData = new FormData();
            formData.append('api_endpoint', document.getElementById('api_endpoint').value);
            formData.append('api_key', document.getElementById('api_key').value);
            formData.append('model', document.getElementById('model').value);
            
            fetch('{{ url_for("test_api") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    result.innerHTML = `<div class="alert alert-success"><i class="bi bi-check-circle"></i> ${data.message}</div>`;
                } else {
                    result.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> ${data.message}</div>`;
                }
            })
            .catch(error => {
                result.innerHTML = `<div class="alert alert-danger"><i class="bi bi-x-circle"></i> 测试失败: ${error.message}</div>`;
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> 测试API连接';
            });
        });

        // 测试已保存的API连接
        document.getElementById('test_saved_api')?.addEventListener('click', function() {
            const btn = this;
            const configId = document.getElementById('api_config_id').value;
            
            btn.disabled = true;
            btn.innerHTML = '<i class="bi bi-hourglass"></i> 测试中...';
            
            const formData = new FormData();
            formData.append('config_id', configId);
            
            fetch('{{ url_for("test_api") }}', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('API连接成功！');
                } else {
                    alert('API连接失败: ' + data.message);
                }
            })
            .catch(error => {
                alert('测试失败: ' + error.message);
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-check-circle"></i> 测试连接';
            });
        });

        // 表单提交前的验证
        document.querySelector('form').addEventListener('submit', function(e) {
            const brandConfigType = document.querySelector('input[name="brand_config_type"]:checked').value;
            const apiConfigType = document.querySelector('input[name="api_config_type"]:checked').value;
            
            // 设置隐藏字段来标识使用的配置类型
            if (brandConfigType === 'saved') {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'use_saved_brands';
                input.value = '1';
                this.appendChild(input);
            }
            
            if (apiConfigType === 'saved') {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'use_saved_api';
                input.value = '1';
                this.appendChild(input);
            }
        });

        // 初始化页面状态
        document.addEventListener('DOMContentLoaded', function() {
            // 触发品牌配置类型的初始化
            const checkedBrandRadio = document.querySelector('input[name="brand_config_type"]:checked');
            if (checkedBrandRadio) {
                checkedBrandRadio.dispatchEvent(new Event('change'));
            }
            
            // 触发API配置类型的初始化
            const checkedApiRadio = document.querySelector('input[name="api_config_type"]:checked');
            if (checkedApiRadio) {
                checkedApiRadio.dispatchEvent(new Event('change'));
            }
        });
    </script>
</body>
</html>
